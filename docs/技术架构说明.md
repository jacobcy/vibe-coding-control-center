# Vibe Coding Control Center - 技术架构说明

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                  Vibe Coding Control Center                 │
│                    (Bash 脚本管理工具)                       │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ Claude Code  │    │  OpenCode    │    │ MCP Servers  │
│  (官方工具)   │    │ (中国工具)    │    │ (扩展功能)    │
└──────────────┘    └──────────────┘    └──────────────┘
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ Anthropic    │    │ 阿里云通义    │    │ GitHub API   │
│   API        │    │   千问 API    │    │ Brave Search │
└──────────────┘    └──────────────┘    └──────────────┘
```

## 🔧 核心组件

### 1. 控制中心 (vibecoding.sh)

**功能**：提供菜单驱动的交互界面

```bash
./scripts/vibecoding.sh
```

**菜单选项**：
- IGNITION - 初始化新项目
- EQUIP - 安装/更新工具
- DIAGNOSTICS - 系统诊断

**实现**：
- 使用 Bash 脚本
- 调用其他安装和配置脚本
- 提供用户友好的交互界面

### 2. 安装脚本

#### install-claude.sh（Claude Code 官方）

```bash
./install/install-claude.sh
```

**执行流程**：
1. 检查并安装 Claude CLI
2. 配置环境变量（从 keys.env 读取）
3. 创建配置目录（~/.claude/）
4. 配置 MCP 服务器
5. 设置命令别名

**关键配置**：
```bash
ANTHROPIC_API_KEY=sk-ant-xxxxx
ANTHROPIC_BASE_URL=https://api.anthropic.com
ANTHROPIC_MODEL=claude-3-5-sonnet-20241022
```

#### install-opencode.sh（OpenCode 中国）

```bash
./install/install-opencode.sh
```

**执行流程**：
1. 检查并安装 OpenCode CLI
2. 配置环境变量（从 keys.env 读取）
3. 安装 oh-my-opencode 扩展
4. 设置命令别名

**关键配置**：
```bash
OPEN_CODE_AUTH_TOKEN=sk-sp-xxxxx
OPEN_CODE_BASE_URL=https://coding.dashscope.aliyuncs.com/apps/opencode
OPEN_CODE_MODEL=qwen3-coder-plus
```

### 3. 配置管理

#### keys.env（实际配置，不提交）

存储所有 API 密钥和环境变量：

```bash
# Claude Code
ANTHROPIC_API_KEY=sk-ant-xxxxx
ANTHROPIC_BASE_URL=https://api.anthropic.com
ANTHROPIC_MODEL=claude-3-5-sonnet-20241022

# OpenCode
OPEN_CODE_AUTH_TOKEN=sk-sp-xxxxx
OPEN_CODE_BASE_URL=https://coding.dashscope.aliyuncs.com/apps/opencode
OPEN_CODE_MODEL=qwen3-coder-plus

# MCP Servers
GITHUB_PERSONAL_ACCESS_TOKEN=github_pat_xxxxx
BRAVE_API_KEY=BSAwxxxxx
```

#### keys.template.env（模板，提交到 git）

提供配置模板，包含占位符：

```bash
ANTHROPIC_API_KEY=sk-ant-xxxxxxxxxxxxxxxxxxxxxxxx
OPEN_CODE_AUTH_TOKEN=sk-opencode-xxxxxxxx
```

### 4. 工具库 (lib/)

#### utils.sh（核心工具函数）

提供共享的工具函数：

```bash
# 日志函数
log_info "信息"
log_warn "警告"
log_error "错误"
log_success "成功"

# 验证函数
validate_input "用户输入"
validate_path "/path/to/file"
validate_filename "filename.txt"

# 文件操作
secure_copy "source" "dest"
secure_write_file "path" "content"

# 用户交互
confirm_action "确认操作？"
prompt_user "请输入："
```

#### utils_secure.sh（安全工具）

提供安全相关的函数：
- 输入验证
- 路径验证
- 防止注入攻击

## 🌐 API 端点对比

### Claude Code（官方）

| 配置项 | 值 |
|--------|-----|
| API 端点 | `https://api.anthropic.com` |
| 模型 | `claude-3-5-sonnet-20241022` |
| 认证方式 | API Key（`sk-ant-` 开头）|
| 网络要求 | 需要国际网络访问 |
| 适用地区 | 全球（中国大陆除外）|

### OpenCode（中国）

| 配置项 | 值 |
|--------|-----|
| API 端点 | `https://coding.dashscope.aliyuncs.com/apps/opencode` |
| 模型 | `qwen3-coder-plus`（通义千问）|
| 认证方式 | Token（`sk-sp-` 开头）|
| 网络要求 | 中国大陆网络即可 |
| 适用地区 | 中国大陆 |

## 🔄 工作流程

### 用户执行命令

```bash
c "帮我写代码"
```

### 执行流程

```
1. Shell 读取别名
   alias c="claude"

2. 执行 claude 命令
   /Users/xxx/.local/bin/claude

3. Claude CLI 读取环境变量
   ANTHROPIC_API_KEY
   ANTHROPIC_BASE_URL
   ANTHROPIC_MODEL

4. 发送请求到 API
   POST https://api.anthropic.com/v1/messages
   Headers: x-api-key: sk-ant-xxxxx
   Body: { model: "claude-3-5-sonnet-20241022", ... }

5. 返回响应
   AI 生成的代码
```

## 🎯 关键设计原则

### 1. 简单直接
- 不使用复杂的"模型映射"
- 直接通过环境变量配置
- 每个工具独立运行

### 2. 安全第一
- API 密钥不提交到 git
- 所有用户输入都验证
- 路径操作都检查

### 3. 模块化
- 共享函数放在 lib/
- 每个工具独立安装脚本
- 配置集中管理

### 4. 用户友好
- 菜单驱动界面
- 命令别名简化操作
- 详细的日志输出

## 📊 数据流

```
用户输入
   ↓
命令别名 (aliases.sh)
   ↓
CLI 工具 (claude / opencode)
   ↓
环境变量 (keys.env)
   ↓
API 端点 (Anthropic / 阿里云)
   ↓
AI 模型响应
   ↓
用户输出
```

## 🔐 安全机制

1. **API 密钥隔离**
   - keys.env 不提交到 git
   - .gitignore 排除敏感文件

2. **输入验证**
   - 所有用户输入都验证
   - 防止路径遍历攻击
   - 防止命令注入

3. **权限控制**
   - 配置文件权限检查
   - 安全的文件操作函数

## 💡 总结

这个项目的核心是：
1. **工具管理器** - 统一管理多个 AI 工具
2. **配置中心** - 集中管理环境变量和 API 密钥
3. **简单直接** - 不搞复杂的映射，直接用环境变量

"中国模式"就是使用 OpenCode 这个独立工具，而不是什么"模型映射"！

