# Vibe Coding Control Center - 技术架构说明

## 🏗️ 整体架构（现状 + 目标态）

```
┌─────────────────────────────────────────────────────────────┐
│                  Vibe Coding Control Center                 │
│                    (Zsh 脚本管理工具)                        │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌────────────┬────────────┬────────────┬────────────┐
        │            │            │            │            │
        ▼            ▼            ▼            ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ Claude Code  │ │  OpenCode    │ │   Codex      │ │ MCP Servers  │
│  (优先工具)   │ │ (多模型)      │ │ (第三优先级) │ │ (扩展功能)    │
└──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
        │            │            │            │
        ▼            ▼            ▼            ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ Anthropic    │ │ 多模型 API   │ │ OpenAI API   │ │ GitHub API   │
│ API/中转站   │ │ (Qwen等)     │ │              │ │ Brave Search │
└──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
```

## 🔧 核心组件

### 1. 控制中心 (vibecoding.sh)

**功能**：提供菜单驱动的交互界面

```bash
./scripts/vibecoding.sh
```

**菜单选项**：
- IGNITION - 初始化新项目
- tool - 安装/更新工具
- DIAGNOSTICS - 系统诊断

**实现**：
- 使用 Zsh 脚本
- 调用其他安装和配置脚本
- 提供用户友好的交互界面

### 2. 安装脚本

#### install-claude.sh（Claude Code 官方）

```bash
./install/install-claude.sh
```

**执行流程**：
1. 检查并安装 Claude CLI
2. 配置环境变量（从 keys.env 读取）
3. 创建配置目录（~/.claude/）
4. 配置 MCP 服务器
5. 设置命令别名

**关键配置（示例）**：
```bash
ANTHROPIC_AUTH_TOKEN=<your-auth-token-here>
ANTHROPIC_BASE_URL=https://api.anthropic.com
ANTHROPIC_MODEL=claude-sonnet-4-5

# 中国默认（中转站，示例）
ANTHROPIC_BASE_URL=https://api.myprovider.com  # 替换成你的中转站
```

#### install-opencode.sh（OpenCode 多模型）

```bash
./install/install-opencode.sh
```

**执行流程**：
1. 检查并安装 OpenCode CLI
2. 配置环境变量（从 keys.env 读取）
3. 安装 oh-my-opencode 扩展
4. 设置命令别名

**关键配置**：
```bash
DEEPSEEK_API_KEY=<your-deepseek-key-here>
MOONSHOT_API_KEY=<your-moonshot-key-here>
```

### 3. 配置管理

#### keys.env（实际配置，不提交）

存储所有 API 密钥和环境变量：

```bash
# Claude Code
ANTHROPIC_AUTH_TOKEN=<your-auth-token-here>
ANTHROPIC_BASE_URL=https://api.anthropic.com
ANTHROPIC_MODEL=claude-sonnet-4-5

# OpenCode（可选）
DEEPSEEK_API_KEY=<your-deepseek-key-here>
MOONSHOT_API_KEY=<your-moonshot-key-here>

# MCP Servers
GITHUB_PERSONAL_ACCESS_TOKEN=<your-github-token-here>
BRAVE_API_KEY=<your-brave-api-key-here>
```

#### keys.template.env（模板，提交到 git）

提供配置模板，包含占位符：

```bash
ANTHROPIC_AUTH_TOKEN=<your-auth-token-here>
```

### 4. Agent 配置 (.agent/)
- **context/**: 存放 AI 记忆与上下文 (`memory.md`, `task.md`, `agent.md`：初始化后生成)
- **workflows/**: 自动化工作流定义 (`feature-commit`, `tdd`, etc.)
- **templates/**: 提示词模板 (`commit-msg`, `pr`)
- **rules/**: 行为规则 (`coding-standards`)

### 5. 工具库 (lib/)

#### utils.sh（核心工具函数）

提供共享的工具函数：

```bash
# 日志函数
log_info "信息"
log_warn "警告"
log_error "错误"
log_success "成功"

# 验证函数
validate_input "用户输入"
validate_path "/path/to/file"
validate_filename "filename.txt"

# 文件操作
secure_copy "source" "dest"
secure_write_file "path" "content"

# 用户交互
confirm_action "确认操作？"
prompt_user "请输入："
```

## 🌐 API 端点对比（现状 + 目标态）

### Claude Code（官方）

| 配置项 | 值 |
|--------|-----|
| API 端点 | `https://api.anthropic.com`（可切换为中转站 `https://api.myprovider.com  # 替换成你的中转站`） |
| 模型 | `claude-sonnet-4-5` |
| 认证方式 | Auth Token（`sk-ant-` 或 `sk-sp-` 开头）|
| 网络要求 | 需要国际网络访问 |
| 适用地区 | 全球（中国大陆除外）|

### OpenCode（多模型）

| 配置项 | 值 |
|--------|-----|
| API 端点 | 由 OpenCode 选用的模型供应商决定 |
| 模型 | Qwen / DeepSeek / Moonshot 等 |
| 认证方式 | 对应模型的 API Key（可选） |
| 网络要求 | 取决于模型供应商 |
| 适用地区 | 视供应商而定 |

## 🔄 工作流程

### 用户执行命令（示例）

```bash
c "帮我写代码"
```

### 执行流程

```
1. Shell 读取别名
   alias c="claude"

2. 执行 claude 命令
   <claude-cli 路径>

3. Claude CLI 读取环境变量
   ANTHROPIC_AUTH_TOKEN
   ANTHROPIC_BASE_URL
   ANTHROPIC_MODEL

4. 发送请求到 API
   POST https://api.anthropic.com/v1/messages (示例)
   Headers: x-api-key: <your-auth-token-here>
   Body: { model: "claude-sonnet-4-5", ... }

5. 返回响应
   AI 生成的代码
```

## 🎯 关键设计原则

### 1. 简单直接
- 不使用复杂的"模型映射"
- 直接通过环境变量配置
- 每个工具独立运行

### 2. 安全第一
- API 密钥不提交到 git
- 所有用户输入都验证
- 路径操作都检查

### 3. 模块化
- 共享函数放在 lib/
- 每个工具独立安装脚本
- 配置集中管理

### 4. 用户友好
- 菜单驱动界面
- 命令别名简化操作
- 详细的日志输出

## 📊 数据流

```
用户输入
   ↓
命令别名 (aliases.sh)
   ↓
CLI 工具 (claude / opencode)
   ↓
环境变量 (keys.env)
   ↓
API 端点 (Anthropic / 中转站)
   ↓
AI 模型响应
   ↓
用户输出
```

## 🔐 安全机制

1. **API 密钥隔离**
   - keys.env 不提交到 git
   - .gitignore 排除敏感文件

2. **输入验证**
   - 所有用户输入都验证
   - 防止路径遍历攻击
   - 防止命令注入

3. **权限控制**
   - 配置文件权限检查
   - 安全的文件操作函数

## 💡 总结

这个项目的核心是：
1. **工具管理器** - 统一管理多个 AI 工具
2. **配置中心** - 集中管理环境变量和 API 密钥
3. **简单直接** - 不搞复杂的映射，直接用环境变量

"中国模式"默认使用 Claude 中转站（api.myprovider.com  # 替换成你的中转站），并可搭配 OpenCode 作为多模型补充。
