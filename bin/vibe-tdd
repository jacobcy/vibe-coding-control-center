#!/usr/bin/env zsh
# vibe-tdd - Manage TDD (Test Driven Development) cycles

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load all utility modules like the main script does
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"
source "$VIBE_ROOT/lib/i18n.sh" 
source "$VIBE_ROOT/lib/cache.sh"
source "$VIBE_ROOT/lib/error_handling.sh"
source "$VIBE_ROOT/lib/agents.sh"
source "$VIBE_ROOT/lib/init_project.sh"

# Load config metadata
load_user_config

# Define the same TDD initialization function as in tdd-init.sh
do_tdd_new() {
    local FEATURE_NAME="$1"
    
    if [[ -z "$FEATURE_NAME" ]]; then
        log_error "Usage: vibe tdd new <feature-name>"
        exit 1
    fi

    log_step "Initializing TDD Cycle for: $FEATURE_NAME"

    # 1. Create Test File
    TEST_FILE="tests/test_${FEATURE_NAME}.sh"
    if [[ -f "$TEST_FILE" ]]; then
        log_warn "Test file already exists: $TEST_FILE"
    else
        mkdir -p tests
        cat > "$TEST_FILE" << EOF
#!/usr/bin/env zsh
# $TEST_FILE
# TDD Test for $FEATURE_NAME

source "lib/utils.sh"
source "lib/config.sh"

log_step "Running tests for $FEATURE_NAME..."

# TODO: Implement test cases
# Example:
# if some_command; then
#     log_success "PASS"
# else
#     log_error "FAIL"
#     exit 1
# fi

log_error "Test not implemented yet! (Standard TDD Red Phase)"
exit 1
EOF
        chmod +x "$TEST_FILE"
        log_success "Created test template: $TEST_FILE"
    fi

    # 2. Recommendation
    log_info "Next Steps:"
    echo "1. Edit $TEST_FILE to define expected behavior."
    echo "2. Run it: ./$TEST_FILE (It should FAIL)."
    echo "3. Implement logic until it passes."
    echo "----------------------------------------"
}

# Handle help flag first
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
    echo "vibe-tdd - Manage Test Driven Development (TDD) cycles"
    echo ""
    echo "Usage: vibe tdd <command>"
    echo ""
    echo "Commands:"
    echo "  new <feature>   Create new TDD test template"
    echo ""
    echo "Options:"
    echo "  -h, --help      Show this help message"
    exit 0
fi

# Parse main command
case "${1:-}" in
    new)
        shift
        do_tdd_new "$1"
        ;;
    "")
        # Default behavior
        echo "vibe-tdd - Test Driven Development Manager"
        echo ""
        echo "Usage: vibe tdd new <feature-name>"
        echo "  new <feature>   Create new TDD test template"
        echo ""
        echo "Run 'vibe tdd -h' for more information."
        ;;
    *)
        log_error "Unknown subcommand: $1"
        echo "Usage: vibe tdd new <feature-name>"
        echo "Run 'vibe tdd -h' for help."
        exit 1
        ;;
esac
