#!/usr/bin/env zsh
# vibe-sign - Manage Git user identity for current worktree

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load all utility modules
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"
source "$VIBE_ROOT/lib/config_init.sh"

# Show help if requested
_cmd="${1:-}"
if [[ "$_cmd" == "-h" || "$_cmd" == "--help" || "$_cmd" == "help" ]]; then
    echo "vibe sign - Manage Git user identity for current worktree"
    echo ""
    echo "Usage: vibe sign [agent]"
    echo ""
    echo "Arguments:"
    echo "  agent       Optional agent name (claude, opencode, codex)"
    echo "              If provided, it updates VIBE_AGENT in your keys.env."
    echo ""
    exit 0
fi

# Ensure we are in a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    log_error "Not in a git repository. Cannot apply signature."
    exit 1
fi

AGENT=""
# VIBE_HOME is already determined by lib/config.sh
# It prioritizes local .vibe directories if in a git repo
KEYS_FILE="$VIBE_HOME/keys.env"

# 1. Priority: Explicit Argument
if [[ -n "${1:-}" ]]; then
    AGENT="$1"
    # Persist choice in keys.env if it exists
    if [[ -f "$KEYS_FILE" ]]; then
        if set_env_value "VIBE_AGENT" "$AGENT" "$KEYS_FILE"; then
            log_info "Persisted agent choice in $KEYS_FILE"
        fi
    fi
fi

# 2. Priority: Persisted Choice in keys.env
if [[ -z "$AGENT" && -f "$KEYS_FILE" ]]; then
    AGENT=$(get_env_value "VIBE_AGENT" "$KEYS_FILE" || true)
    
    # Fallback to VIBE_DEFAULT_TOOL if VIBE_AGENT is not set
    if [[ -z "$AGENT" ]]; then
        AGENT=$(get_env_value "VIBE_DEFAULT_TOOL" "$KEYS_FILE" || true)
        [[ -n "$AGENT" ]] && log_info "Using agent from VIBE_DEFAULT_TOOL: $AGENT"
    else
        log_info "Using agent from config: $AGENT"
    fi
fi

# 3. Priority: Directory Name Pattern
if [[ -z "$AGENT" ]]; then
    DIR_NAME=$(basename "$(pwd)")
    if [[ "$DIR_NAME" =~ ^wt-([a-z0-9]+)- ]]; then
        AGENT="${match[1]}"
        log_info "Detected agent from directory: $AGENT"
    fi
fi

# 4. Priority: Interactive Selection
if [[ -z "$AGENT" ]]; then
    log_warn "No agent detected. Please select one:"
    echo "1) claude"
    echo "2) opencode"
    echo "3) codex"
    printf "Choice [1-3]: "
    read -r choice
    case "$choice" in
        2) AGENT="opencode" ;;
        3) AGENT="codex" ;;
        *) AGENT="claude" ;;
    esac
    
    # Save selection
    if [[ -f "$KEYS_FILE" ]]; then
        if set_env_value "VIBE_AGENT" "$AGENT" "$KEYS_FILE"; then
            log_info "Saved selection to $KEYS_FILE"
        fi
    fi
fi

# Set Git identity
AGENT_NAME="Agent-${(C)AGENT}"
AGENT_EMAIL="agent-${AGENT}@vibecoding.ai"

# Ensure worktree config is enabled for isolation
if [[ "$(git config extensions.worktreeConfig)" != "true" ]]; then
    git config extensions.worktreeConfig true
fi

git config --worktree user.name "$AGENT_NAME"
git config --worktree user.email "$AGENT_EMAIL"

log_success "Git signature applied for agent: $AGENT"
echo "  Name:  $AGENT_NAME"
echo "  Email: $AGENT_EMAIL"
