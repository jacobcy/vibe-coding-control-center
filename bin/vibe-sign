#!/usr/bin/env zsh
# vibe-sign - Manage Git user identity for current worktree

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load all utility modules
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"

# Show help if requested
_cmd="${1:-}"
if [[ "$_cmd" == "-h" || "$_cmd" == "--help" || "$_cmd" == "help" ]]; then
    echo "vibe sign - Manage Git user identity for current worktree"
    echo ""
    echo "Usage: vibe sign [agent]"
    echo ""
    echo "Arguments:"
    echo "  agent       Optional agent name (claude, opencode, codex)"
    echo "              If provided, it overrides detection and saves choice."
    echo ""
    exit 0
fi

# Ensure we are in a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    log_error "Not in a git repository. Cannot apply signature."
    exit 1
fi

AGENT=""
LOCAL_AGENT_FILE=""

# Find local .vibe directory to store persistence
if [[ -d ".vibe" ]]; then
    LOCAL_AGENT_FILE=".vibe/agent"
elif git rev-parse --show-toplevel >/dev/null 2>&1; then
    _gr=$(git rev-parse --show-toplevel)
    if [[ -d "$_gr/.vibe" ]]; then
        LOCAL_AGENT_FILE="$_gr/.vibe/agent"
    fi
fi

# 1. Priority: Explicit Argument
if [[ -n "$1" ]]; then
    AGENT="$1"
    # Save choice if we found a .vibe directory
    if [[ -n "$LOCAL_AGENT_FILE" ]]; then
        echo "$AGENT" > "$LOCAL_AGENT_FILE"
        log_info "Saved agent preference to: $LOCAL_AGENT_FILE"
    fi
fi

# 2. Priority: Persisted Choice
if [[ -z "$AGENT" && -f "$LOCAL_AGENT_FILE" ]]; then
    AGENT=$(cat "$LOCAL_AGENT_FILE" | tr -d '[:space:]')
    if [[ -n "$AGENT" ]]; then
        log_info "Using agent from config: $AGENT"
    fi
fi

# 3. Priority: Directory Name Pattern
if [[ -z "$AGENT" ]]; then
    DIR_NAME=$(basename "$(pwd)")
    if [[ "$DIR_NAME" =~ ^wt-([a-z0-9]+)- ]]; then
        AGENT="${match[1]}"
        log_info "Detected agent from directory: $AGENT"
    fi
fi

# 4. Priority: Interactive Selection (if still not found or in raw main)
if [[ -z "$AGENT" ]]; then
    log_warn "No agent detected. Please select one:"
    echo "1) claude"
    echo "2) opencode"
    echo "3) codex"
    printf "Choice [1-3]: "
    read -r choice
    case "$choice" in
        2) AGENT="opencode" ;;
        3) AGENT="codex" ;;
        *) AGENT="claude" ;;
    esac
fi

# Set Git identity
AGENT_NAME="Agent-${(C)AGENT}"
AGENT_EMAIL="agent-${AGENT}@vibecoding.ai"

git config user.name "$AGENT_NAME"
git config user.email "$AGENT_EMAIL"

log_success "Git signature applied for agent: $AGENT"
echo "  Name:  $AGENT_NAME"
echo "  Email: $AGENT_EMAIL"
