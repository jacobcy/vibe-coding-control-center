#!/usr/bin/env zsh
# vibe-config - AI tool configuration manager

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load all utility modules
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"
source "$VIBE_ROOT/lib/i18n.sh"

# Show AI tool configuration status
show_config_status() {
    echo "=== AI Tool Configuration Status ==="
    echo ""
    
    echo "${BOLD}[Claude] ~/.claude.json${NC}"
    local claude_config="$HOME/.claude.json"
    if [[ -f "$claude_config" ]]; then
        # Try to list servers using python for robust JSON parsing
        if command -v python3 &>/dev/null; then
            local servers=""
            if servers=$(python3 -c "import json, sys; 
try:
    with open('$claude_config') as f: data = json.load(f);
    servers = list(data.get('mcpServers', {}).keys());
    print(', '.join(servers))
except: sys.exit(1)" 2>/dev/null) && [[ -n "$servers" ]]; then
                 echo "  ✅ Config found (servers: $servers)"
            else
                 local srv_count=$(grep -o '"command"' "$claude_config" 2>/dev/null | wc -l | xargs || echo "0")
                 echo "  ✅ Config found ($srv_count MCP servers)"
            fi
        else
            local srv_count=$(grep -o '"command"' "$claude_config" 2>/dev/null | wc -l | xargs || echo "0")
            echo "  ✅ Config found ($srv_count MCP servers)"
        fi
    else
        echo "  ❌ Config not found"
        echo "  → Run: vibe env mcp"
    fi
    
    echo ""
    echo "${BOLD}[OpenCode] ~/.config/opencode/opencode.json${NC}"
    local oc_config="$HOME/.config/opencode/opencode.json"
    if [[ -f "$oc_config" ]]; then
        # Try to list providers
        if command -v python3 &>/dev/null; then
             local providers=""
             if providers=$(python3 -c "import json, sys; 
try:
    with open('$oc_config') as f: data = json.load(f);
    # OpenCode config has a 'provider' object where keys are the provider IDs
    providers = list(data.get('provider', {}).keys());
    print(', '.join(providers))
except: sys.exit(1)" 2>/dev/null) && [[ -n "$providers" ]]; then
                 # Truncate if too long
                 if [[ ${#providers} -gt 60 ]]; then
                     providers="${providers:0:60}..."
                 fi
                 echo "  ✅ Config found (providers: $providers)"
             else
                 local provider_count=$(grep -o '"name"' "$oc_config" 2>/dev/null | wc -l | xargs || echo "0")
                 echo "  ✅ Config found ($provider_count providers)"
             fi
        else
            local provider_count=$(grep -o '"name"' "$oc_config" 2>/dev/null | wc -l | xargs || echo "0")
            echo "  ✅ Config found ($provider_count providers)"
        fi
    else
        echo "  ❌ Config not found"
        echo "  → Run: vibe equip (select OpenCode)"
    fi
    
    echo ""
    echo "${BOLD}[Codex] ~/.codex/config.toml${NC}"
    local codex_config="$HOME/.codex/config.toml"
    if [[ -f "$codex_config" ]]; then
        # improved toml parsing: strict match and take first only
        local model=$(grep '^[[:space:]]*model[[:space:]]*=' "$codex_config" 2>/dev/null | head -n 1 | cut -d'"' -f2 | cut -d"'" -f2)
        echo "  ✅ Config found${model:+ (model: $model)}"
    else
        echo "  ❌ Config not found"
    fi
    
    echo ""
    echo "${BOLD}Note:${NC} For environment variables (API keys), use ${CYAN}vibe env${NC}"
}

# Show comprehensive config list (masked)
show_config_list() {
    echo "=== Configuration Values ==="
    echo ""
    # Keys
    if [[ -f "$VIBE_HOME/keys.env" ]]; then
        echo "${BOLD}[keys.env]${NC}"
        while IFS= read -r line || [[ -n "$line" ]]; do
            [[ "$line" =~ ^[[:space:]]*# ]] && continue
            [[ -z "${line//[[:space:]]/}" ]] && continue
            if [[ "$line" =~ ^([^=]+)=(.*)$ ]]; then
                key="${match[1]}"
                val="${match[2]}"
                # Remove quotes
                val="${val%\"}"
                val="${val#\"}"
                
                # Check directly for sensitive keywords in key name
                if [[ "$key" =~ "TOKEN" || "$key" =~ "KEY" || "$key" =~ "AUTH" || "$key" =~ "PASS" || "$key" =~ "SECRET" ]]; then
                    if [[ ${#val} -gt 8 ]]; then
                        echo "  $key = ${val:0:4}...${val: -4}"
                    else
                        echo "  $key = ****"
                    fi
                else
                    echo "  $key = $val"
                fi
            fi
        done < "$VIBE_HOME/keys.env"
    fi
}

do_edit() {
    local target="$1"
    case "$target" in
        keys)
            open_editor "$VIBE_HOME/keys.env"
            ;;
        claude)
            open_editor "$HOME/.claude.json"
            ;;
        opencode)
            open_editor "$HOME/.config/opencode/opencode.json"
            ;;
        codex)
            open_editor "$HOME/.codex/config.toml"
            ;;
        alias)
            open_editor "$HOME/.vibe/aliases.sh"
            ;;
        *)
            log_error "Unknown edit target: $target"
            echo "Available: keys, claude, opencode, codex, alias"
            exit 2
            ;;
    esac
}

# Handle commands
CMD="${1:-}"
START_ARG=2

if [[ -z "$CMD" ]]; then
    show_config_status
    exit 0
fi

case "$CMD" in
    list)
        show_config_list
        ;;
    edit)
        TARGET="${2:-}"
        if [[ -z "$TARGET" ]]; then
            # Legacy behavior or prompt?
            echo "Usage: vibe config edit <target>"
            echo "Targets: keys, claude, opencode, codex, alias"
            exit 2
        fi
        do_edit "$TARGET"
        ;;
    
    # Legacy direct commands mapped to edit/show or keep as shortcuts?
    # Standard says: vibe config <target> -> show details?
    # For now let's map them to edit if they are tools, to match old behavior but maybe we should follow standard
    # User said: vibe config <target> is list (for that target presumably)
    # But user also said "vibe config <target> 就是list" -> means showing layout/status/values for that target?
    
    opencode)
        # Show opencode config details?
        # For now, let's just cat the file or open editor?
        # Old behavior was open editor.
        # User standard: "vibe config <target>: 显示指定目标的配置详情"
        if [[ -f "$HOME/.config/opencode/opencode.json" ]]; then
            cat "$HOME/.config/opencode/opencode.json"
        else
            echo "Config not found."
            exit 3
        fi
        ;;
        
    claude)
        if [[ -f "$HOME/.claude.json" ]]; then
            cat "$HOME/.claude.json"
        else
            echo "Config not found."
            exit 3
        fi
        ;;
        
    codex)
        if [[ -f "$HOME/.codex/config.toml" ]]; then
            cat "$HOME/.codex/config.toml"
        else
            echo "Config not found."
            exit 3
        fi
        ;;

    -h|--help|help)
        cat << 'EOF'
vibe config - AI tool configuration manager

Usage: vibe config [command]

Commands:
  (no args)              Show status of all configuration files
  list                   Show all configuration values (masked)
  edit <target>          Edit configuration file
                         Targets: keys, claude, opencode, codex, alias
  <target>               Show configuration details for target

Examples:
  vibe config                      # Show status
  vibe config list                 # Show values
  vibe config edit keys            # Edit keys.env
  vibe config claude               # Show .claude.json content
EOF
        ;;
    
    *)
        log_error "Unknown command: $CMD"
        echo "Run 'vibe config help' for usage"
        exit 2
        ;;
esac
