#!/usr/bin/env zsh
# vibe-config - AI tool configuration manager

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load all utility modules
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"
source "$VIBE_ROOT/lib/i18n.sh"

# Show AI tool configuration status
show_config_status() {
    echo "=== AI Tool Configuration Status ==="
    echo ""
    
    echo "${BOLD}[Claude] ~/.claude.json${NC}"
    local claude_config="$HOME/.claude.json"
    if [[ -f "$claude_config" ]]; then
        # Try to list servers using python for robust JSON parsing
        if command -v python3 &>/dev/null; then
            local servers=""
            if servers=$(python3 -c "import json, sys; 
try:
    with open('$claude_config') as f: data = json.load(f);
    servers = list(data.get('mcpServers', {}).keys());
    print(', '.join(servers))
except: sys.exit(1)" 2>/dev/null) && [[ -n "$servers" ]]; then
                 echo "  ✅ Config found (servers: $servers)"
            else
                 local srv_count=$(grep -o '"command"' "$claude_config" 2>/dev/null | wc -l | xargs || echo "0")
                 echo "  ✅ Config found ($srv_count MCP servers)"
            fi
        else
            local srv_count=$(grep -o '"command"' "$claude_config" 2>/dev/null | wc -l | xargs || echo "0")
            echo "  ✅ Config found ($srv_count MCP servers)"
        fi
    else
        echo "  ❌ Config not found"
        echo "  → Run: vibe env mcp"
    fi
    
    echo ""
    echo "${BOLD}[OpenCode] ~/.config/opencode/opencode.json${NC}"
    local oc_config="$HOME/.config/opencode/opencode.json"
    if [[ -f "$oc_config" ]]; then
        # Try to list providers
        if command -v python3 &>/dev/null; then
             local providers=""
             if providers=$(python3 -c "import json, sys; 
try:
    with open('$oc_config') as f: data = json.load(f);
    # OpenCode config has a 'provider' object where keys are the provider IDs
    providers = list(data.get('provider', {}).keys());
    print(', '.join(providers))
except: sys.exit(1)" 2>/dev/null) && [[ -n "$providers" ]]; then
                 # Truncate if too long
                 if [[ ${#providers} -gt 60 ]]; then
                     providers="${providers:0:60}..."
                 fi
                 echo "  ✅ Config found (providers: $providers)"
             else
                 local provider_count=$(grep -o '"name"' "$oc_config" 2>/dev/null | wc -l | xargs || echo "0")
                 echo "  ✅ Config found ($provider_count providers)"
             fi
        else
            local provider_count=$(grep -o '"name"' "$oc_config" 2>/dev/null | wc -l | xargs || echo "0")
            echo "  ✅ Config found ($provider_count providers)"
        fi
    else
        echo "  ❌ Config not found"
        echo "  → Run: vibe equip (select OpenCode)"
    fi
    
    echo ""
    echo "${BOLD}[Codex] ~/.codex/config.toml${NC}"
    local codex_config="$HOME/.codex/config.toml"
    if [[ -f "$codex_config" ]]; then
        # improved toml parsing: strict match and take first only
        local model=$(grep '^[[:space:]]*model[[:space:]]*=' "$codex_config" 2>/dev/null | head -n 1 | cut -d'"' -f2 | cut -d"'" -f2)
        echo "  ✅ Config found${model:+ (model: $model)}"
    else
        echo "  ❌ Config not found"
    fi
    
    echo ""
    echo "${BOLD}Note:${NC} For environment variables (API keys), use ${CYAN}vibe env${NC}"
}

# Handle commands
case "${1:-}" in
    "")
        show_config_status
        ;;
    
    opencode)
        open_editor "$HOME/.config/opencode/opencode.json"
        ;;
    
    codex)
        open_editor "$HOME/.codex/config.toml"
        ;;
        
    claude)
         open_editor "$HOME/.claude.json"
         ;;
    
    -h|--help|help)
        cat << 'EOF'
vibe config - AI tool configuration manager

Usage: vibe config [tool]

Commands:
  (no args)              Show all AI tool configuration status
  opencode               Open opencode.json in editor
  codex                  Open config.toml in editor
  claude                 Open .claude.json in editor

Examples:
  vibe config                      # Show status
  vibe config opencode             # Edit OpenCode config
EOF
        ;;
    
    *)
        log_error "Unknown tool: $1"
        echo "Available tools: opencode, codex, claude"
        exit 1
        ;;
esac
