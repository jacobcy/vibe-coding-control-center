#!/usr/bin/env zsh
# v2/bin/vibe - CLI Entry Point for Vibe 2.0
# Target: ~50 lines | Dispatches to lib/ modules

set -e

# ── Context ─────────────────────────────────────────────
VIBE_SCRIPT_DIR="$(cd "$(dirname "${(%):-%x}")" && pwd)"
VIBE_ROOT="$(cd "$VIBE_SCRIPT_DIR/.." && pwd)"
export VIBE_ROOT

source "$VIBE_ROOT/lib/config.sh"

# ── Version ─────────────────────────────────────────────
readonly VIBE_VERSION="$(get_vibe_version)"

# ── Dispatcher ──────────────────────────────────────────
command="${1:-help}"
shift 2>/dev/null || true

case "$command" in
    check)
        source "$VIBE_LIB/check.sh"
        vibe_check "$@"
        ;;
    tool)
        source "$VIBE_LIB/tool.sh"
        vibe_tool "$@"
        ;;
    keys)
        source "$VIBE_LIB/keys.sh"
        vibe_keys "$@"
        ;;
    flow)
        source "$VIBE_LIB/flow.sh"
        vibe_flow "$@"
        ;;
    alias)
        source "$VIBE_CONFIG/aliases.sh"
        log_success "Aliases loaded"
        ;;
    version|-v|--version)
        echo "Vibe $VIBE_VERSION"
        ;;
    help|--help|-h|*)
        echo "${BOLD}Vibe Coding Control Center${NC} v${VIBE_VERSION}"
        echo ""
        echo "Usage: ${CYAN}vibe <command>${NC} [args]"
        echo ""
        echo "Commands:"
        echo "  ${GREEN}check${NC}    检测开发环境（工具版本、依赖状态）"
        echo "  ${GREEN}tool${NC}    安装/更新 AI 开发工具（claude, opencode, codex）"
        echo "  ${GREEN}keys${NC}     管理 API 密钥（list, set, get）"
        echo "  ${GREEN}flow${NC}     开发工作流（start, review, pr, done）"
        echo "  ${GREEN}alias${NC}    加载 shell 快捷别名"
        echo "  ${GREEN}version${NC}  显示版本号"
        echo "  ${GREEN}help${NC}     显示此帮助信息"
        ;;
esac
