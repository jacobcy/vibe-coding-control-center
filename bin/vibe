#!/usr/bin/env zsh
# vibe dispatcher (git-style)

set -e

# Context shim: auto-switch to the local project's vibe when a .vibe/ directory
# is found nearby.  VIBE_ROOT is inferred from the .vibe parent — no config needed.
if [[ -z "${VIBE_NO_SHIM}" ]]; then
    _local_vibe=""
    # Walk up from PWD looking for .vibe/
    _cur="$PWD"
    while [[ "$_cur" != "/" ]]; do
        if [[ -d "${_cur}/.vibe" ]]; then
            _local_vibe="${_cur}"
            break
        fi
        _cur="$(dirname "$_cur")"
    done
    # Fallback: git root
    if [[ -z "$_local_vibe" ]] && command -v git >/dev/null 2>&1 \
        && git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        _gr="$(git rev-parse --show-toplevel 2>/dev/null)"
        [[ -d "${_gr}/.vibe" ]] && _local_vibe="${_gr}"
    fi

    if [[ -n "${_local_vibe}" ]]; then
        _local_bin="${_local_vibe}/bin/vibe"
        _current_script_abs="$(cd "$(dirname "${(%):-%x}")" && pwd)/$(basename "${(%):-%x}")"

        # If local bin exists, is executable, and is NOT this script → hand over
        if [[ -x "${_local_bin}" && "${_local_bin}" != "${_current_script_abs}" ]]; then
            export VIBE_NO_SHIM=1
            exec "${_local_bin}" "$@"
        fi
    fi
fi

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Check for help flags or subcommand first
if [[ $# -eq 1 ]] && [[ "$1" == "-h" || "$1" == "--help" ]]; then
    if [[ -f "$VIBE_ROOT/lib/vibe-help.md" ]]; then
        cat "$VIBE_ROOT/lib/vibe-help.md"
    else
        echo "Vibe Coding Control Center"
        echo "Help file missing at lib/vibe-help.md. Run 'vibe' for interactive mode."
    fi
    exit 0
elif [[ "$1" == "help" ]]; then
    # Implement 'vibe help' command
    if [[ $# -eq 1 ]]; then
        # 'vibe help' - show general help
        if [[ -f "$VIBE_ROOT/lib/vibe-help.md" ]]; then
            cat "$VIBE_ROOT/lib/vibe-help.md"
        else
            echo "Vibe Coding Control Center"
            echo ""
            echo "Usage: vibe [options] [command]"
            echo ""
            echo "Options:"
            echo "  -h, --help     Show this help message"
            echo ""
            echo "Commands:"
            echo "  (no args)      Launch interactive control center"
            echo "  chat           Start default AI tool chat"
            echo "  config         Manage Vibe Coding configuration"
            echo "  doctor         System health check (includes diagnostics)"
            echo "  env            Environment and key management"
            echo "  equip          Install/update AI tools"
            echo "  flow           Feature development workflow"
            echo "  help           Show help information"
            echo "  init           Start New Project"
            echo "  keys           Quick access to API keys"
            echo "  sign           Sync Git Identity"
            echo ""
            echo "Run 'vibe' without arguments for interactive mode."
        fi
    else
        # 'vibe help <subcommand>' - show help for specific subcommand
        shift  # Remove 'help' argument
        subcmd="$1"
        cmd="${VIBE_ROOT}/bin/vibe-${subcmd}"
        if [[ -x "$cmd" ]]; then
            "$cmd" --help
        else
            echo "Unknown subcommand: $subcmd" >&2
            echo "Available: $(ls -1 "$VIBE_ROOT/bin" | sed -n 's/^vibe-//p' | tr '\n' ' ')" >&2
        fi
    fi
    exit 0
fi

if [[ $# -gt 0 ]]; then
  subcmd="$1"
  shift
  cmd="${VIBE_ROOT}/bin/vibe-${subcmd}"
  if [[ -x "$cmd" ]]; then
    exec "$cmd" "$@"
  else
    echo "Unknown subcommand: $subcmd" >&2
    echo "Available: $(ls -1 "$VIBE_ROOT/bin" | sed -n 's/^vibe-//p' | tr '\n' ' ')" >&2
    exit 1
  fi
fi

# No subcommand -> run interactive control center
exec zsh "${VIBE_ROOT}/scripts/vibecoding.sh"
