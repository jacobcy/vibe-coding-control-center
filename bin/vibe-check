#!/usr/bin/env zsh
# vibe-check - System diagnostics and health checks

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load utility modules
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"
source "$VIBE_ROOT/lib/i18n.sh" 
source "$VIBE_ROOT/lib/error_handling.sh"

# Ensure keys are loaded
load_keys

# ================= CHECK SYSTEM =================

do_check_system() {
    echo -e "\n${BOLD}SYSTEM HEALTH STATUS:${NC}"

    # 1. OpenCode
    if command -v opencode &> /dev/null; then
        OPENCODE_VERSION=$(get_command_version "opencode" "--version")
        log_info "OpenCode       : Installed (v${OPENCODE_VERSION:-unknown})"
    else
        log_error "OpenCode       : Missing"
    fi

    # 2. Claude
    if command -v claude &> /dev/null; then
        CLAUDE_VERSION=$(get_command_version "claude" "--version")
        log_info "Claude Code    : Installed (v${CLAUDE_VERSION:-unknown})"
    else
        log_warn "Claude Code    : Missing (Optional)"
    fi

    # 3. oh-my-opencode
    if [[ -f "$HOME/.config/opencode/opencode.json" ]] && grep -q "oh-my-opencode" "$HOME/.config/opencode/opencode.json"; then
        log_info "oh-my-opencode : Installed"
    else
        log_warn "oh-my-opencode : Not installed"
    fi

    # 4. Dependencies
    for cmd in tmux lazygit zsh git; do
        if command -v "$cmd" &> /dev/null; then
            log_info "$(printf "%-14s" "$cmd") : Found"
        else
            log_error "$(printf "%-14s" "$cmd") : Missing"
        fi
    done

    # 5. Shell Config
    SHELL_RC="$HOME/.zshrc"
    if [ -f "$SHELL_RC" ]; then
        log_info ".zshrc found"
        # Check for key aliases
        local aliases=("c" "o" "vibe" "wt")
        for a in "${aliases[@]}"; do
            if grep -q "alias $a=" "$SHELL_RC"; then
                  log_info "Alias '$a' configured"
            else
                  log_warn "Alias '$a' likely missing"
            fi
        done
    else
        log_error ".zshrc not found"
    fi
    
    echo -e "${BLUE}====================================${NC}"
}

# ================= CHECK API =================

do_check_api() {
    echo -e "\n${BOLD}API CONNECTIVITY CHECK:${NC}"
    
    # 1. Anthropic (Claude)
    local token=$(config_get_key "ANTHROPIC_AUTH_TOKEN")
    local base_url="${ANTHROPIC_BASE_URL:-https://api.anthropic.com}"
    
    if [[ -n "$token" ]]; then
        printf "%-14s : " "Anthropic"
        # Remove trailing slash
        base_url="${base_url%/}"
        
        local http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "x-api-key: $token" \
            -H "anthropic-version: 2023-06-01" \
            "$base_url/v1/models" --max-time 5 2>/dev/null || echo "000")
            
        if [[ "$http_code" == "200" ]]; then
            echo "${GREEN}✅ Connected${NC} (Base: $base_url)"
        elif [[ "$http_code" == "401" ]]; then
            echo "${RED}❌ Invalid Token${NC}"
        else
            echo "${RED}❌ Failed (HTTP $http_code)${NC} (Base: $base_url)"
        fi
    else
        log_warn "Anthropic      : Skipped (Token not configured)"
    fi

    # 2. OpenAI
    local openai_key="${OPENAI_API_KEY:-${VIBE_CONFIG[KEY_OPENAI_API_KEY]:-}}"
    local openai_base="${OPENAI_BASE_URL:-https://api.openai.com/v1}"
    
    if [[ -n "$openai_key" ]]; then
        printf "%-14s : " "OpenAI"
        openai_base="${openai_base%/}"
        
        local http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $openai_key" \
            "$openai_base/models" --max-time 5 2>/dev/null || echo "000")
            
        if [[ "$http_code" == "200" ]]; then
             echo "${GREEN}✅ Connected${NC} (Base: $openai_base)"
        else
             echo "${RED}❌ Failed (HTTP $http_code)${NC}"
        fi
    else
        # Optional, only warn if user expects it
        : 
    fi

    # 3. GitHub
    local gh_token=$(config_get_key "GITHUB_PERSONAL_ACCESS_TOKEN")
    if [[ -n "$gh_token" ]]; then
        printf "%-14s : " "GitHub"
        local http_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token $gh_token" \
            "https://api.github.com/user" --max-time 5 2>/dev/null || echo "000")
            
        if [[ "$http_code" == "200" ]]; then
            echo "${GREEN}✅ Connected${NC}"
        else
            echo "${RED}❌ Failed (HTTP $http_code)${NC}"
        fi
    else
        log_warn "GitHub         : Skipped (Token not configured)"
    fi
    
    # 4. Brave
    local brave_key=$(config_get_key "BRAVE_API_KEY")
    if [[ -n "$brave_key" ]]; then
         log_info "Brave Search   : Key Configured"
    else
         log_warn "Brave Search   : Skipped (Key not configured)"
    fi
}

# ================= CHECK MCP =================

do_check_mcp() {
    echo -e "\n${BOLD}MCP SERVER REGISTRY CHECK:${NC}"
    local config_file="$HOME/.claude.json"

    if [[ ! -f "$config_file" ]]; then
        log_warn "Config missing: $config_file"
        return
    fi

    if command -v python3 &>/dev/null; then
        python3 -c '
import json, sys, shutil, os
try:
    with open("'"$config_file"'", "r") as f:
        data = json.load(f)
    servers = data.get("mcpServers", {})
    if not servers:
        print("NO_SERVERS")
        sys.exit(0)
    print("{} servers configured.".format(len(servers)))
    print("{:<20} {:<15} COMMAND".format("SERVER", "STATUS"))
    print("-" * 60)
    for name, config in servers.items():
        cmd = config.get("command")
        if not cmd:
            print("{:<20} ✗ Invalid       (No command)".format(name))
            continue
        if shutil.which(cmd):
            print("{:<20} ✓ Valid         {}".format(name, cmd))
        else:
            print("{:<20} ✗ Missing       {}".format(name, cmd))
except Exception as e:
    print("ERROR: {}".format(e))
    sys.exit(1)
'
    else
        local count=$(grep -o "\"command\"" "$config_file" | wc -l)
        echo "  Configured Servers: $count (Install python3 for detailed check)"
    fi
}

# ================= CHECK ENV =================

do_check_env() {
    echo -e "\n${BOLD}VIBE ENVIRONMENT CHECK:${NC}"

    local vibe_home="${VIBE_HOME:-$HOME/.vibe}"
    local issues=0

    # 1. Check VIBE_HOME
    echo "Environment Location: $vibe_home"

    if [[ ! -d "$vibe_home" ]]; then
        log_error "Vibe environment not found"
        log_info "Run 'vibe env init' to initialize"
        return 1
    fi
    log_success "Environment directory exists"

    # 2. Check vibe.yaml
    if [[ -f "$vibe_home/vibe.yaml" ]]; then
        log_success "vibe.yaml found"

        # Parse and show info
        if type parse_vibe_yaml >/dev/null 2>&1; then
            parse_vibe_yaml "$vibe_home/vibe.yaml" 2>/dev/null
            local name=$(vibe_yaml_get name "unnamed")
            local version=$(vibe_yaml_get version "unknown")
            echo "  Name: $name"
            echo "  Version: $version"
        fi
    else
        log_error "vibe.yaml missing"
        ((issues++))
    fi

    # 3. Check keys directory
    echo ""
    echo "Keys Configuration:"
    if [[ -d "$vibe_home/keys" ]]; then
        local key_count=0
        for f in "$vibe_home/keys"/*.env(N); do
            ((key_count += 1))
        done
        log_info "Key groups: $key_count"

        # Check current key
        local current_group
        current_group=$(get_current_keys_group 2>/dev/null || echo "unknown")
        echo "  Current: $current_group"

        # Check if keys are set
        local keys_file="$vibe_home/keys/${current_group}.env"
        if [[ -f "$keys_file" ]]; then
            if grep -q "ANTHROPIC_AUTH_TOKEN=$" "$keys_file" 2>/dev/null; then
                log_warn "ANTHROPIC_AUTH_TOKEN is empty"
            elif grep -q "ANTHROPIC_AUTH_TOKEN=" "$keys_file" 2>/dev/null; then
                log_success "ANTHROPIC_AUTH_TOKEN configured"
            fi
        fi
    else
        log_error "Keys directory missing"
        ((issues++))
    fi

    # 4. Check tools
    echo ""
    echo "Tools:"
    if [[ -d "$vibe_home/tools" ]]; then
        local tool_count=0
        for tool_dir in "$vibe_home/tools"/*(N/); do
            ((tool_count += 1))
            local name=$(basename "$tool_dir")
            if [[ -f "$tool_dir/enabled" ]]; then
                echo "  $name: enabled ✓"
            else
                echo "  $name: disabled"
            fi
        done
        if [[ $tool_count -eq 0 ]]; then
            log_warn "No tools installed"
        fi
    else
        log_warn "Tools directory not found"
    fi

    # 5. Check MCP
    echo ""
    echo "MCP Servers:"
    if type vibe_yaml_get_list >/dev/null 2>&1; then
        local mcp_list=$(vibe_yaml_get_list mcp 2>/dev/null)
        if [[ -n "$mcp_list" ]]; then
            for mcp in $mcp_list; do
                echo "  $mcp ✓"
            done
        else
            echo "  No MCP servers configured"
        fi
    else
        echo "  (vibe.yaml not parsed)"
    fi

    # Summary
    echo ""
    if [[ $issues -eq 0 ]]; then
        log_success "Environment check passed"
    else
        log_warn "Found $issues issue(s)"
    fi
}

# ================= MAIN =================

show_help() {
    echo "vibe check - System diagnostics"
    echo ""
    echo "Usage: vibe check [command]"
    echo ""
    echo "Commands:"
    echo "  all            Run all checks (default)"
    echo "  system         Check system health and dependencies"
    echo "  api            Check API connectivity"
    echo "  mcp            Check MCP server status"
    echo "  env            Check Vibe environment configuration"
    echo ""
    echo "Examples:"
    echo "  vibe check"
    echo "  vibe check api"
    echo "  vibe check env"
    echo ""
}

COMMAND="${1:-all}"

case "$COMMAND" in
    system)
        do_check_system
        ;;
    api)
        do_check_api
        ;;
    mcp)
        do_check_mcp
        ;;
    env)
        do_check_env
        ;;
    all)
        do_check_system
        do_check_api
        do_check_mcp
        do_check_env
        ;;
    -h|--help|help)
        show_help
        ;;
    *)
        # Default fallback to all if unknown, or maybe show help? 
        # But 'vibe check' with no args comes here as 'all' via default above.
        show_help
        exit 2
        ;;
esac
