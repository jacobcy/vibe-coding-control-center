#!/usr/bin/env zsh
# vibe-doctor - Display system health information and run diagnostics

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load all utility modules like the main script does
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"
source "$VIBE_ROOT/lib/i18n.sh" 
source "$VIBE_ROOT/lib/cache.sh"
source "$VIBE_ROOT/lib/error_handling.sh"
source "$VIBE_ROOT/lib/agents.sh"
source "$VIBE_ROOT/lib/init_project.sh"

# Load config metadata
load_user_config

# Define the check_status function similar to the main script
check_status() {
    echo -e "\n${BOLD}SYSTEM HEALTH STATUS:${NC}"

    # 1. OpenCode
    if command -v opencode &> /dev/null; then
        OPENCODE_VERSION=$(get_command_version "opencode" "--version")
        if [[ -n "$OPENCODE_VERSION" ]]; then
            log_info "OpenCode       : Installed (v$OPENCODE_VERSION)"
        else
            log_info "OpenCode       : Installed (version unknown)"
        fi
    else
        log_error "OpenCode       : Missing"
    fi

    # 2. Claude
    if command -v claude &> /dev/null; then
        CLAUDE_VERSION=$(get_command_version "claude" "--version")
        if [[ -n "$CLAUDE_VERSION" ]]; then
            log_info "Claude Code    : Installed (v$CLAUDE_VERSION)"
        else
            log_info "Claude Code    : Installed (version unknown)"
        fi
    else
        log_warn "Claude Code    : Missing (Optional)"
    fi

    # 3. oh-my-opencode
    # 3. oh-my-opencode
    if [[ -f "$HOME/.config/opencode/opencode.json" ]] && grep -q "oh-my-opencode" "$HOME/.config/opencode/opencode.json"; then
        log_info "oh-my-opencode : Installed"
    else
        log_warn "oh-my-opencode : Not installed"
    fi

    # 4. Environment
    KEYS_FILE="$VIBE_HOME/keys.env"
    if [ -f "$KEYS_FILE" ]; then
        log_info "Keys Config    : Found ($KEYS_FILE)"
    else
        log_warn "Keys Config    : Missing ($KEYS_FILE)"
    fi

    # 5. MCP Configuration
    if [ -f "$HOME/.claude.json" ]; then
        SERVER_COUNT=$(grep -o "\"command\"" "$HOME/.claude.json" 2>/dev/null | wc -l | tr -d ' ')
        log_info "MCP Config     : Found ($SERVER_COUNT servers)"
    else
        log_warn "MCP Config     : Missing (.claude.json)"
    fi

    echo -e "${BLUE}====================================${NC}"
}



check_connections() {
    echo -e "\n${BOLD}API CONNECTIVITY CHECK:${NC}"
    
    # Ensure keys are loaded
    load_keys

    # 1. OpenAI Check
    local openai_key="${OPENAI_API_KEY:-${VIBE_CONFIG[KEY_OPENAI_API_KEY]:-}}"
    local openai_base="${OPENAI_BASE_URL:-${VIBE_CONFIG[KEY_OPENAI_BASE_URL]:-https://api.openai.com/v1}}"
    
    # Remove trailing slash from base url if present for consistent appending
    openai_base="${openai_base%/}"

    if [[ -n "$openai_key" ]]; then
        printf "%-14s : " "OpenAI"
        # Simple models list check. 
        # Note: Some relays might not support /models, so /chat/completions dry-run is more robust but costlier.
        # Sticking to /models for lightweight check first.
        local response
        if response=$(curl -s -o /dev/null -w "%{http_code}" -X GET "$openai_base/models" \
            -H "Authorization: Bearer $openai_key" --max-time 5); then
            
            if [[ "$response" == "200" ]]; then
                log_info "Connected (Base: $openai_base)"
            else
                log_error "Failed (HTTP $response)"
                echo "      Endpoint: $openai_base/models"
            fi
        else
            log_error "Connection Error (Base: $openai_base)"
        fi
    else
        log_warn "OpenAI         : Skipped (Missing OPENAI_API_KEY)"
    fi

    # 2. Anthropic Check
    # Support both API_KEY and AUTH_TOKEN (common in some setups)
    local claude_key="${ANTHROPIC_API_KEY:-${VIBE_CONFIG[KEY_ANTHROPIC_API_KEY]:-}}"
    if [[ -z "$claude_key" ]]; then
        claude_key="${ANTHROPIC_AUTH_TOKEN:-${VIBE_CONFIG[KEY_ANTHROPIC_AUTH_TOKEN]:-}}"
    fi
    
    local claude_base="${ANTHROPIC_BASE_URL:-${VIBE_CONFIG[KEY_ANTHROPIC_BASE_URL]:-https://api.anthropic.com/v1}}"
    claude_base="${claude_base%/}"

    if [[ -n "$claude_key" ]]; then
        printf "%-14s : " "Anthropic"
        local response
        # Anthropic requires x-api-key and anthropic-version
        if response=$(curl -s -o /dev/null -w "%{http_code}" -X GET "$claude_base/models" \
            -H "x-api-key: $claude_key" \
            -H "anthropic-version: 2023-06-01" \
            --max-time 5); then

            if [[ "$response" == "200" ]]; then
                 log_info "Connected (Base: $claude_base)"
            else
                 log_error "Failed (HTTP $response)"
                 echo "      Endpoint: $claude_base/models"
            fi
        else
            log_error "Connection Error (Base: $claude_base)"
        fi
    else
        log_warn "Anthropic      : Skipped (Missing ANTHROPIC_API_KEY or ANTHROPIC_AUTH_TOKEN)"
    fi

}

check_mcp() {
    echo -e "\n${BOLD}MCP SERVER REGISTRY CHECK:${NC}"
    local config_file="$HOME/.claude.json"
    
    if [[ ! -f "$config_file" ]]; then
        log_warn "Config missing: $config_file"
        return
    fi
    
    log_info "Config found: $config_file"

    if command -v python3 &>/dev/null; then
        # Use python for robust JSON parsing
        python3 -c '
import json, sys, shutil, os

try:
    with open("'"$config_file"'", "r") as f:
        data = json.load(f)
    
    servers = data.get("mcpServers", {})
    if not servers:
        print("NO_SERVERS")
        sys.exit(0)

    print("{} servers configured.".format(len(servers)))
    print("{:<20} {:<15} COMMAND".format("SERVER", "STATUS"))
    print("-" * 60)

    for name, config in servers.items():
        cmd = config.get("command")
        if not cmd:
            print("{:<20} ✗ Invalid       (No command)".format(name))
            continue
            
        # Check if command exists
        if shutil.which(cmd):
            print("{:<20} ✓ Valid         {}".format(name, cmd))
        else:
            print("{:<20} ✗ Missing       {}".format(name, cmd))

except json.JSONDecodeError:
    print("JSON_ERROR")
    sys.exit(1)
except Exception as e:
    print("ERROR: {}".format(e))
    sys.exit(1)
'
    else
        # Fallback to simple grep if python missing (unlikely in this env)
        local count=$(grep -o "\"command\"" "$config_file" | wc -l)
        echo "  Configured Servers: $count (Install python3 for detailed check)"
    fi
}

# Extended diagnostics function
do_diagnostics() {
    echo -e "\n${CYAN}>> RUNNING COMPREHENSIVE DIAGNOSTICS <<${NC}"
    echo "Checking core connections..."

    echo "Checking core connections..."

    # Check Connectivity first
    # (Note: keys are checked separately via --all or keys command, but kept here for legacy 'do_diagnostics' calls)
    check_connections

    # Check MCP config
    check_mcp

    # Additional Dependencies
    echo -e "\n${BOLD}DEPENDENCIES:${NC}"
    for cmd in tmux lazygit zsh git; do
        if command -v "$cmd" &> /dev/null; then
            log_info "$(printf "%-14s" "$cmd") : Found"
        else
            log_error "$(printf "%-14s" "$cmd") : Missing"
        fi
    done

    # Aliases Check
    echo -e "\n${BOLD}SHELL CONFIGURATION:${NC}"
    SHELL_RC="$HOME/.zshrc"
    if [ -f "$SHELL_RC" ]; then
        log_info ".zshrc found"
        local aliases=("c" "o" "x" "vibe" "vnew" "wt")
        for a in "${aliases[@]}"; do
            if grep -q "alias $a=" "$SHELL_RC"; then
                  log_info "Alias '$a' configured"
            else
                  log_warn "Alias '$a' likely missing"
            fi
        done
    else
        log_error ".zshrc not found"
    fi

    echo -e "\n${CYAN}Diagnostics complete.${NC}"
}

# Handle help flag
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" || "${1:-}" == "help" ]]; then
    echo "vibe-doctor - Display system health information and run diagnostics"
    echo ""
    echo "Usage: vibe doctor [command] [options]"
    echo ""
    echo "Commands:"
    echo "  status         Show system health status (default)"
    echo "  keys           Check API connectivity"
    echo "  mcp            Check MCP server registry"
    echo "  help           Show this help message"
    echo ""
    echo "Options:"
    echo "  --diagnostics  Same as 'keys' (legacy compatibility)"
    echo "  --all          Show status, keys, and mcp checks"
    echo ""
    exit 0
fi

# Determine what to show based on arguments
COMMAND="${1:-status}"

case "$COMMAND" in
    status)
        check_status
        ;;
    keys|--diagnostics)
        check_connections
        ;;
    mcp)
        check_mcp
        ;;
    --all)
        check_status
        do_diagnostics # Comprehensive diagnostics wrapper
        ;;
    *)
        # Default behavior for unknown args is to try and match partial args or fallback to status
        check_status
        ;;
esac
