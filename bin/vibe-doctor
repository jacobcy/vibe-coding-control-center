#!/usr/bin/env zsh
# vibe-doctor - Display system health information and run diagnostics

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load all utility modules like the main script does
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"
source "$VIBE_ROOT/lib/i18n.sh" 
source "$VIBE_ROOT/lib/cache.sh"
source "$VIBE_ROOT/lib/error_handling.sh"
source "$VIBE_ROOT/lib/agents.sh"
source "$VIBE_ROOT/lib/init_project.sh"

# Load config metadata
load_user_config

# Define the check_status function similar to the main script
check_status() {
    echo -e "\n${BOLD}SYSTEM HEALTH STATUS:${NC}"

    # 1. OpenCode
    if command -v opencode &> /dev/null; then
        OPENCODE_VERSION=$(get_command_version "opencode" "--version")
        if [[ -n "$OPENCODE_VERSION" ]]; then
            log_info "OpenCode       : Installed (v$OPENCODE_VERSION)"
        else
            log_info "OpenCode       : Installed (version unknown)"
        fi
    else
        log_error "OpenCode       : Missing"
    fi

    # 2. Claude
    if command -v claude &> /dev/null; then
        CLAUDE_VERSION=$(get_command_version "claude" "--version")
        if [[ -n "$CLAUDE_VERSION" ]]; then
            log_info "Claude Code    : Installed (v$CLAUDE_VERSION)"
        else
            log_info "Claude Code    : Installed (version unknown)"
        fi
    else
        log_warn "Claude Code    : Missing (Optional)"
    fi

    # 3. oh-my-opencode
    if [ -f "$HOME/.oh-my-opencode/install.sh" ]; then
        log_info "oh-my-opencode : Installed"
    else
        log_warn "oh-my-opencode : Not installed"
    fi

    # 4. Environment
    KEYS_FILE="$VIBE_HOME/keys.env"
    if [ -f "$KEYS_FILE" ]; then
        log_info "Keys Config    : Found ($KEYS_FILE)"
    else
        log_warn "Keys Config    : Missing ($KEYS_FILE)"
    fi

    # 5. MCP Configuration
    if [ -f "$HOME/.claude.json" ]; then
        SERVER_COUNT=$(grep -o "\"command\"" "$HOME/.claude.json" 2>/dev/null | wc -l | tr -d ' ')
        log_info "MCP Config     : Found ($SERVER_COUNT servers)"
    else
        log_warn "MCP Config     : Missing (.claude.json)"
    fi

    echo -e "${BLUE}====================================${NC}"
}

# Extended diagnostics function
do_diagnostics() {
    echo -e "\n${CYAN}>> RUNNING COMPREHENSIVE DIAGNOSTICS <<${NC}"
    echo "Checking core connections..."

    # Check MCP config
    if [ -f "$HOME/.claude.json" ]; then
        log_info "MCP Configuration found (.claude.json)"
        # Count servers using grep as a simple heuristic
        SERVER_COUNT=$(grep -o "\"command\"" "$HOME/.claude.json" | wc -l)
        echo -e "  - Configured Servers: $SERVER_COUNT"
    else
        log_error "MCP Configuration missing"
    fi

    # Additional Dependencies
    echo -e "\n${BOLD}DEPENDENCIES:${NC}"
    for cmd in tmux lazygit zsh git; do
        if command -v "$cmd" &> /dev/null; then
            log_info "$(printf "%-14s" "$cmd") : Found"
        else
            log_error "$(printf "%-14s" "$cmd") : Missing"
        fi
    done

    # Aliases Check
    echo -e "\n${BOLD}SHELL CONFIGURATION:${NC}"
    SHELL_RC="$HOME/.zshrc"
    if [ -f "$SHELL_RC" ]; then
        log_info ".zshrc found"
        local aliases=("c" "o" "x" "vibe" "vnew" "wt")
        for a in "${aliases[@]}"; do
            if grep -q "alias $a=" "$SHELL_RC"; then
                 log_info "Alias '$a' configured"
            else
                 log_warn "Alias '$a' likely missing"
            fi
        done
    else
        log_error ".zshrc not found"
    fi

    echo -e "\n${CYAN}Diagnostics complete.${NC}"
}

# Handle help flag
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
    echo "vibe-doctor - Display system health information and run diagnostics"
    echo ""
    echo "Usage: vibe doctor [options]"
    echo ""
    echo "Options:"
    echo "  -h, --help    Show this help message"
    echo "  --health      Show system health status only (default)"
    echo "  --diagnostics Show comprehensive diagnostics"
    echo "  --all         Show both health status and diagnostics"
    echo ""
    echo "Examples:"
    echo "  vibe doctor          # Health status only"
    echo "  vibe doctor --health # Health status only"
    echo "  vibe doctor --diagnostics # Comprehensive diagnostics"
    echo "  vibe doctor --all    # Both health and diagnostics"
    exit 0
fi

# Determine what to show based on arguments
if [[ "${1:-}" == "--diagnostics" ]]; then
    do_diagnostics
elif [[ "${1:-}" == "--all" ]]; then
    check_status
    do_diagnostics
else
    # Default behavior or --health flag
    check_status
fi
