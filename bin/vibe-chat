#!/usr/bin/env zsh
# vibe-chat - Start default AI tool chat with natural language routing

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load all utility modules like the main script does
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"
source "$VIBE_ROOT/lib/i18n.sh"
source "$VIBE_ROOT/lib/cache.sh"
source "$VIBE_ROOT/lib/error_handling.sh"
source "$VIBE_ROOT/lib/agents.sh"
source "$VIBE_ROOT/lib/init_project.sh"

# Load manager modules
source "$VIBE_ROOT/lib/keys_manager.sh"
source "$VIBE_ROOT/lib/tool_manager.sh"
source "$VIBE_ROOT/lib/mcp_manager.sh"
source "$VIBE_ROOT/lib/skill_manager.sh"
source "$VIBE_ROOT/lib/env_manager.sh"
source "$VIBE_ROOT/lib/chat_router.sh"

# Load config metadata
load_user_config
export_keys  # Export loaded configuration to environment variables

do_chat() {
    local tool
    local prompt="$1"
    tool=$(vibe_select_default_tool) || exit 1

    # Show current tool info
    local model_info=""
    if [[ "$tool" == "opencode" ]]; then
        model_info="${VIBE_OPENCODE_MODEL:-default}"
    elif [[ "$tool" == "claude" ]]; then
        model_info="${ANTHROPIC_MODEL:-default}"
    fi
    
    if [[ -n "$model_info" ]]; then
        echo "ğŸ¤– Using AI Tool: \033[1;36m$tool\033[0m (Model: $model_info)"
    else
        echo "ğŸ¤– Using AI Tool: \033[1;36m$tool\033[0m"
    fi

    # å¦‚æœæœ‰å‚æ•°ï¼Œä½¿ç”¨éäº¤äº’å¼å‘½ä»¤
    if [[ -n "$prompt" ]]; then
        case "$tool" in
            claude)
                if ! claude -p "$prompt"; then
                    log_error "Claude CLI execution failed."
                    echo "ğŸ’¡ Tip: If you were trying to run a Vibe command (like 'flow'), please check your syntax."
                    echo "   You might be running 'vibe chat' inadvertently."
                    exit 1
                fi
                ;;
            opencode)
                if [[ -n "${VIBE_OPENCODE_MODEL:-}" ]]; then
                    opencode run "$prompt" -m "$VIBE_OPENCODE_MODEL"
                else
                    opencode run "$prompt"
                fi
                ;;
            codex)
                codex exec "$prompt"
                ;;
            *)
                log_error "Unsupported tool: $tool"
                exit 1
                ;;
        esac
    else
        # æ— å‚æ•°æ—¶å¯åŠ¨äº¤äº’æ¨¡å¼
        case "$tool" in
            claude)
                claude
                ;;
            opencode)
                opencode
                ;;
            codex)
                codex
                ;;
            *)
                log_error "Unsupported tool: $tool"
                exit 1
                ;;
        esac
    fi
}

# Handle help flag
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" || "${1:-}" == "help" ]]; then
    echo "vibe-chat - AI å¯¹è¯å…¥å£ (æ”¯æŒè‡ªç„¶è¯­è¨€å‘½ä»¤)"
    echo ""
    echo "ç”¨æ³•:"
    echo "  vibe chat              å¯åŠ¨äº¤äº’å¼å¯¹è¯"
    echo "  vibe chat \"æ¶ˆæ¯\"      å‘é€æ¶ˆæ¯æˆ–æ‰§è¡Œå‘½ä»¤"
    echo ""
    echo "è¯´æ˜:"
    echo "  è‡ªåŠ¨è¯†åˆ«æ„å›¾å¹¶è·¯ç”±åˆ°ç›¸åº”å‘½ä»¤ï¼Œæˆ–ä¼ é€’ç»™ AI å·¥å…·"
    echo ""
    echo "ç¤ºä¾‹ - å‘½ä»¤æ¨¡å¼:"
    echo "  vibe chat åˆ‡æ¢åˆ° openai          # åˆ‡æ¢å¯†é’¥ç»„"
    echo "  vibe chat å®‰è£… claude            # å®‰è£…å·¥å…·"
    echo "  vibe chat æ·»åŠ  github mcp       # æ·»åŠ  MCP"
    echo "  vibe chat æ£€æŸ¥çŠ¶æ€              # æŸ¥çœ‹ç¯å¢ƒçŠ¶æ€"
    echo ""
    echo "ç¤ºä¾‹ - AI å¯¹è¯æ¨¡å¼:"
    echo "  vibe chat å¦‚ä½•ä½¿ç”¨ git rebase   # AI å›ç­”é—®é¢˜"
    echo "  vibe chat å¸®æˆ‘å†™ä¸ª hello world # AI å¸®ä½ å†™ä»£ç "
    echo ""
    echo "é€‰é¡¹:"
    echo "  -h, --help    æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    exit 0
fi

# Try intent routing first
_message="$*"

if [[ -n "$_message" ]]; then
    # Try to route the message to a command
    if vibe_chat_route "$_message"; then
        # Intent was handled
        exit 0
    fi
    # Fall through to AI chat
fi

# Run the chat function with all arguments
do_chat "$*"
