#!/usr/bin/env zsh
# vibe-chat - Start default AI tool chat

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load all utility modules like the main script does
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"
source "$VIBE_ROOT/lib/i18n.sh" 
source "$VIBE_ROOT/lib/cache.sh"
source "$VIBE_ROOT/lib/error_handling.sh"
source "$VIBE_ROOT/lib/agents.sh"
source "$VIBE_ROOT/lib/init_project.sh"

# Load config metadata
load_user_config
export_keys  # Export loaded configuration to environment variables

do_chat() {
    local tool
    local prompt="$1"
    tool=$(vibe_select_default_tool) || exit 1

    # Show current tool info
    local model_info=""
    if [[ "$tool" == "opencode" ]]; then
        model_info="${VIBE_OPENCODE_MODEL:-default}"
    elif [[ "$tool" == "claude" ]]; then
        model_info="${ANTHROPIC_MODEL:-default}"
    fi
    
    if [[ -n "$model_info" ]]; then
        echo "ğŸ¤– Using AI Tool: \033[1;36m$tool\033[0m (Model: $model_info)"
    else
        echo "ğŸ¤– Using AI Tool: \033[1;36m$tool\033[0m"
    fi

    # å¦‚æœæœ‰å‚æ•°ï¼Œä½¿ç”¨éäº¤äº’å¼å‘½ä»¤
    if [[ -n "$prompt" ]]; then
        case "$tool" in
            claude)
                if ! claude -p "$prompt"; then
                    log_error "Claude CLI execution failed."
                    echo "ğŸ’¡ Tip: If you were trying to run a Vibe command (like 'flow'), please check your syntax."
                    echo "   You might be running 'vibe chat' inadvertently."
                    exit 1
                fi
                ;;
            opencode)
                if [[ -n "${VIBE_OPENCODE_MODEL:-}" ]]; then
                    opencode run "$prompt" -m "$VIBE_OPENCODE_MODEL"
                else
                    opencode run "$prompt"
                fi
                ;;
            codex)
                codex exec "$prompt"
                ;;
            *)
                log_error "Unsupported tool: $tool"
                exit 1
                ;;
        esac
    else
        # æ— å‚æ•°æ—¶å¯åŠ¨äº¤äº’æ¨¡å¼
        case "$tool" in
            claude)
                claude
                ;;
            opencode)
                opencode
                ;;
            codex)
                codex
                ;;
            *)
                log_error "Unsupported tool: $tool"
                exit 1
                ;;
        esac
    fi
}

# Handle help flag
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" || "${1:-}" == "help" ]]; then
    echo "vibe-chat - å¿«é€Ÿå¯åŠ¨ AI å·¥å…·å¯¹è¯"
    echo ""
    echo "ç”¨æ³•:"
    echo "  vibe chat              å¯åŠ¨äº¤äº’å¼å¯¹è¯"
    echo "  vibe chat \"é—®é¢˜\"       å¿«é€Ÿé—®ç­”ï¼ˆéäº¤äº’å¼ï¼‰"
    echo ""
    echo "è¯´æ˜:"
    echo "  è‡ªåŠ¨ä½¿ç”¨é»˜è®¤ AI å·¥å…· (Claude, OpenCode æˆ– Codex)"
    echo "  ç»Ÿä¸€çš„å‘½ä»¤æ¥å£ï¼Œæ— éœ€è®°å¿†ä¸åŒå·¥å…·çš„å‘½ä»¤æ ¼å¼"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  vibe chat                          # å¯åŠ¨äº¤äº’æ¨¡å¼"
    echo "  vibe chat \"å¦‚ä½•ä½¿ç”¨ git rebase\"    # å¿«é€Ÿé—®ç­”"
    echo ""
    echo "é«˜çº§ç”¨æ³• (OpenCode):"
    echo "  vibe chat skills                   # æŸ¥çœ‹å¯ç”¨æŠ€èƒ½"
    echo "  vibe chat status                   # æŸ¥çœ‹çŠ¶æ€"
    echo "  vibe chat \"/slash_command\"       # æ‰§è¡Œ OpenCode æ–œæ å‘½ä»¤"
    echo ""
    echo "é€‰é¡¹:"
    echo "  -h, --help    æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    exit 0
fi

# Run the chat function with all arguments
do_chat "$*"
