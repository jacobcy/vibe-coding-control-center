#!/usr/bin/env zsh
# vibe-env - Environment management command

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load all utility modules
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"
source "$VIBE_ROOT/lib/config_init.sh"
source "$VIBE_ROOT/lib/i18n.sh"
source "$VIBE_ROOT/lib/env_manager.sh"

KEYS_FILE="$VIBE_HOME/keys.env"

# Show help
show_help() {
    cat << 'EOF'
vibe env - Environment manager

Usage: vibe env <command> [options]

Environment Management:
  init [--force]     Initialize Vibe environment (~/.vibe)
  export [file]      Export configuration (to file or stdout)
  import <file>      Import configuration from tarball
  status             Show environment status
  reset [--force]    Reset environment (with backup)

Runtime Variables:
  (no args)          Show resolved environment variables with source
  edit               Edit local keys.env
  inject             Inject keys.env into current shell session
  sync               Sync project's keys.env from template

Examples:
  vibe env init                    # Initialize ~/.vibe
  vibe env status                  # Show environment status
  vibe env export vibe-backup.tar.gz
  vibe env                         # Show current vars
  vibe env edit                    # Edit keys

Configuration: ~/.vibe/
EOF
}

# Helper: Show resolved env vars
show_resolved_env() {
    echo "=== Runtime Environment (Resolved) ==="
    echo ""
    
    # Define keys to check
    local keys_of_interest=(
        "ANTHROPIC_API_KEY" "ANTHROPIC_AUTH_TOKEN" "ANTHROPIC_BASE_URL" "ANTHROPIC_MODEL"
        "OPENAI_API_KEY" "OPENAI_BASE_URL" "OPENAI_MODEL"
        "GITHUB_PERSONAL_ACCESS_TOKEN"
        "BRAVE_API_KEY"
        "VIBE_DEFAULT_TOOL"
    )

    # Pre-load local keys for comparison
    declare -A local_keys
    if [[ -f "$KEYS_FILE" ]]; then
        while IFS= read -r line || [[ -n "$line" ]]; do
            if [[ "$line" =~ ^([^=]+)=(.*)$ ]]; then
                k="${match[1]}"
                v="${match[2]}"
                v="${v%\"}" # remove quotes
                v="${v#\"}"
                local_keys[$k]="$v"
            fi
        done < "$KEYS_FILE"
    fi

    for key in "${keys_of_interest[@]}"; do
        # Current env value
        local current_val="${(P)key-}"
        local local_val="${local_keys[$key]:-}"
        local display_val=""
        local source_label=""
        
        if [[ -n "$current_val" ]]; then
            # Mask value
            if [[ ${#current_val} -gt 8 ]]; then
                display_val="${current_val:0:4}...${current_val: -4}"
            else
                display_val="****"
            fi
            
            if [[ "$current_val" == "$local_val" ]]; then
                source_label="${GREEN}[Local]${NC}"
            else
                source_label="${YELLOW}[Global/Shell]${NC}"
            fi
            
            printf "  %-30s %-15s %s\n" "$key" "$source_label" "$display_val"
        else
            # Not in env
            if [[ -n "$local_val" ]]; then
                printf "  %-30s %-15s %s\n" "$key" "${CYAN}[Local (Not Loaded)]${NC}" "Run 'vibe env inject'"
            else
                 # Only show if verbose? or skip
                 :
            fi
        fi
    done
}

# Handle commands
case "${1:-}" in
    "")
        show_resolved_env
        ;;

    # Environment management commands
    init)
        vibe_env_init "$2"
        ;;

    export)
        vibe_env_export "$2"
        ;;

    import)
        vibe_env_import "$2"
        ;;

    reset)
        vibe_env_reset "$2"
        ;;

    status)
        vibe_env_status
        ;;

    edit)
        # Shortcut to config edit keys
        exec "${VIBE_ROOT}/bin/vibe-config" edit keys
        ;;
    
    inject)
        # Export keys to current shell session
        exec zsh "$VIBE_ROOT/scripts/env-manager.sh" inject
        ;;
    
    sync)
        # Sync project keys.env
        if sync_keys_env "$VIBE_ROOT"; then
            log_info "Configuration synced to $KEYS_FILE"
        else
            log_error "Failed to sync configuration"
            exit 3
        fi
        ;;
        
    -h|--help|help)
        show_help
        ;;
    
    verify|check|detect)
        echo "⚠️  Command moved to 'vibe check api' or 'vibe check system'"
        exec "${VIBE_ROOT}/bin/vibe-check" api
        ;;

    keys)
         echo "⚠️  Command deprecated. Use 'vibe env' to list or 'vibe config edit keys' to edit." >&2
         exit 2
         ;;

    switch)
         echo "⚠️  Command removed. Please edit keys.env directly: vibe config edit keys" >&2
         exit 2
         ;;

    *)
        log_error "Unknown command: $1"
        echo "Run 'vibe env help' for usage"
        exit 2
        ;;
esac
