#!/usr/bin/env zsh
# vibe-env - Environment variable configuration manager

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load all utility modules
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"
source "$VIBE_ROOT/lib/config_init.sh"
source "$VIBE_ROOT/lib/i18n.sh"

KEYS_FILE="$VIBE_HOME/keys.env"

# Show help
show_help() {
    cat << 'EOF'
vibe env - Environment variable configuration manager

Usage: vibe env <command> [options]

Commands:
  status              Show environment status (default)
  show                Show keys.env content (masked)
  edit                Edit keys.env in your editor
  get <key>           Get specific environment variable
  set <key> <value>   Set environment variable
  sync                Sync project's keys.env to user directory
  detect              Detect and validate environment
  inject              Export keys to current shell session
  switch <cn|off>     Switch Claude API endpoint
  verify              Verify API key validity

Examples:
  vibe env                           # Show status
  vibe env show                      # Show all keys (masked)
  vibe env set VIBE_DEFAULT_TOOL claude
  vibe env get ANTHROPIC_MODEL
  vibe env sync                      # Sync from project config
  vibe env verify                    # Test API keys

Configuration file: ~/.vibe/keys.env (Default)
Path Resolution: Local .vibe/ > Git Root .vibe/ > User ~/.vibe/
EOF
}

# Helper: Show resolved env vars
show_resolved_env() {
    echo "=== Runtime Environment (Resolved) ==="
    echo ""
    
    # Define keys to check
    local keys_of_interest=(
        "ANTHROPIC_API_KEY" "ANTHROPIC_AUTH_TOKEN" "ANTHROPIC_BASE_URL" "ANTHROPIC_MODEL"
        "OPENAI_API_KEY" "OPENAI_BASE_URL" "OPENAI_MODEL"
        "GITHUB_PERSONAL_ACCESS_TOKEN"
        "BRAVE_API_KEY"
        "VIBE_DEFAULT_TOOL"
    )

    # Pre-load local keys for comparison
    declare -A local_keys
    if [[ -f "$KEYS_FILE" ]]; then
        while IFS= read -r line || [[ -n "$line" ]]; do
            if [[ "$line" =~ ^([^=]+)=(.*)$ ]]; then
                k="${match[1]}"
                v="${match[2]}"
                v="${v%\"}" # remove quotes
                v="${v#\"}"
                local_keys[$k]="$v"
            fi
        done < "$KEYS_FILE"
    fi

    for key in "${keys_of_interest[@]}"; do
        # Current env value
        local current_val="${(P)key-}"
        local local_val="${local_keys[$key]:-}"
        local display_val=""
        local source_label=""
        
        if [[ -n "$current_val" ]]; then
            # Mask value
            if [[ ${#current_val} -gt 8 ]]; then
                display_val="${current_val:0:4}...${current_val: -4}"
            else
                display_val="****"
            fi
            
            if [[ "$current_val" == "$local_val" ]]; then
                source_label="${GREEN}[Local]${NC}"
            else
                source_label="${YELLOW}[Global/Shell]${NC}"
            fi
            
            printf "  %-30s %-15s %s\n" "$key" "$source_label" "$display_val"
        else
            # Not in env
            if [[ -n "$local_val" ]]; then
                printf "  %-30s %-15s %s\n" "$key" "${CYAN}[Local (Not Loaded)]${NC}" "Run 'vibe env inject'"
            else
                 # Only show if verbose? or skip
                 :
            fi
        fi
    done
}

# Handle commands
case "${1:-}" in
    "")
        show_resolved_env
        ;;
    
    edit)
        # Shortcut to config edit keys
        exec "${VIBE_ROOT}/bin/vibe-config" edit keys
        ;;
    
    inject)
        # Export keys to current shell session
        exec zsh "$VIBE_ROOT/scripts/env-manager.sh" inject
        ;;
    
    sync)
        # Sync project keys.env
        if sync_keys_env "$VIBE_ROOT"; then
            log_info "Configuration synced to $KEYS_FILE"
        else
            log_error "Failed to sync configuration"
            exit 3
        fi
        ;;
        
    -h|--help|help)
        show_help
        ;;
    
    verify|check|detect)
        echo "⚠️  Command moved to 'vibe check api' or 'vibe check system'"
        exec "${VIBE_ROOT}/bin/vibe-check" api
        ;;

    keys)
         echo "⚠️  Command deprecated. Use 'vibe env' to list or 'vibe config edit keys' to edit." >&2
         exit 2
         ;;

    switch)
         echo "⚠️  Command removed. Please edit keys.env directly: vibe config edit keys" >&2
         exit 2
         ;;

    *)
        log_error "Unknown command: $1"
        echo "Run 'vibe env help' for usage"
        exit 2
        ;;
esac
