#!/usr/bin/env zsh
# vibe-signature - Manage Git user identity for current worktree

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load all utility modules
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"

# Show help if requested
if [[ "$1" == "-h" || "$1" == "--help" || "$1" == "help" ]]; then
    echo "vibe signature - Manage Git user identity for current worktree"
    echo ""
    echo "Usage: vibe signature [agent]"
    echo "       vibe sign [agent]     (alias)"
    echo ""
    echo "Arguments:"
    echo "  agent       Optional agent name (claude, opencode, codex)"
    echo "              If omitted, it attempts to detect from worktree name."
    echo ""
    exit 0
fi

# Ensure we are in a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    log_error "Not in a git repository. Cannot apply signature."
    exit 1
fi

# Detect agent from directory name or argument
# Pattern: wt-<agent>-<branch>
AGENT="${1:-}"
if [[ -z "$AGENT" ]]; then
    DIR_NAME=$(basename "$(pwd)")
    if [[ "$DIR_NAME" =~ ^wt-([a-z0-9]+)- ]]; then
        AGENT="${match[1]}"
        log_info "Detected agent from directory: $AGENT"
    else
        AGENT="claude" # Default fallback
    fi
fi

# Set Git identity
AGENT_NAME="Agent-${(C)AGENT}"
AGENT_EMAIL="agent-${AGENT}@vibecoding.ai"

git config user.name "$AGENT_NAME"
git config user.email "$AGENT_EMAIL"

log_success "Git signature applied for agent: $AGENT"
echo "  Name:  $AGENT_NAME"
echo "  Email: $AGENT_EMAIL"
