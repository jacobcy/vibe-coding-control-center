#!/usr/bin/env zsh
# vibe-alias - Manage command aliases

set -e

VIBE_ROOT="$(cd "$(dirname "${(%):-%x}")/.." && pwd)"

# Load utility modules
source "$VIBE_ROOT/lib/utils.sh"
source "$VIBE_ROOT/lib/config.sh"
source "$VIBE_ROOT/lib/i18n.sh"

# Find the actual aliases.sh file
# Priority: 1. Current project's config/aliases.sh
#          2. Global ~/.vibe/aliases.sh
ALIASES_FILE=""
ALIASES_DIR=""
if [[ -f "$VIBE_ROOT/config/aliases.sh" ]]; then
    ALIASES_FILE="$VIBE_ROOT/config/aliases.sh"
    ALIASES_DIR="$VIBE_ROOT/config/aliases"
elif [[ -f "$HOME/.vibe/aliases.sh" ]]; then
    ALIASES_FILE="$HOME/.vibe/aliases.sh"
    ALIASES_DIR="$HOME/.vibe/aliases"
fi

CUSTOM_ALIASES_FILE="$HOME/.vibe/custom_aliases.sh"

# Ensure custom alias file exists
if [[ ! -f "$CUSTOM_ALIASES_FILE" ]]; then
    touch "$CUSTOM_ALIASES_FILE"
fi

do_list() {
    echo "=== Vibe Aliases (Level 2) ==="
    echo ""

    if [[ -n "$ALIASES_FILE" ]]; then
        echo "${BOLD}[System Aliases]${NC} ($ALIASES_FILE)"
        echo ""

        # Build list of all alias files
        local all_files=("$ALIASES_FILE")
        if [[ -d "$ALIASES_DIR" ]]; then
            # Use explicit file list instead of glob to avoid subshell issues
            local -a alias_files=(
                "$ALIASES_DIR/claude.sh"
                "$ALIASES_DIR/git.sh"
                "$ALIASES_DIR/opencode.sh"
                "$ALIASES_DIR/openspec.sh"
                "$ALIASES_DIR/tmux.sh"
                "$ALIASES_DIR/vibe.sh"
                "$ALIASES_DIR/worktree.sh"
            )
            for f in "${alias_files[@]}"; do
                [[ -f "$f" ]] && all_files+=("$f")
            done
        fi

        # Group aliases by category
        # Note: Use [a-z_]* to match aliases with underscores (e.g., cc_off, vsign)
        # Format alias output: extract name and description
        format_aliases() {
            local pattern="$1"
            grep "$pattern" "${all_files[@]}" 2>/dev/null | \
                awk -F: '{print $NF}' | \
                sed 's/^alias //' | \
                while IFS= read -r line; do
                    # Extract name (before =)
                    name="${line%%=*}"
                    # Get description after = and remove quotes
                    desc="${line#*=}"
                    desc="${desc//[\'\"]/}"  # Remove all quotes
                    # Trim long descriptions for readability
                    if [[ ${#desc} -gt 50 ]]; then
                        desc="${desc:0:47}..."
                    fi
                    [[ -n "$name" ]] && printf "    %-15s - %s\n" "$name" "$desc"
                done
        }

        echo "  ${BOLD}Vibe Commands:${NC}"
        format_aliases "^alias v[a-z_]*="
        echo ""

        echo "  ${BOLD}AI Tools (cc*, oo*):${NC}"
        grep -h -E "^alias cc|^alias oo" "${all_files[@]}" 2>/dev/null | \
                sed 's/^alias //' | \
                while IFS= read -r line; do
                    name="${line%%=*}"
                    desc="${line#*=}"
                    desc="${desc//[\'\"]/}"
                    if [[ ${#desc} -gt 50 ]]; then
                        desc="${desc:0:47}..."
                    fi
                    [[ -n "$name" ]] && printf "    %-15s - %s\n" "$name" "$desc"
                done
        echo ""

        echo "  ${BOLD}OpenSpec Commands (os*):${NC}"
        grep -h "^alias os" "${all_files[@]}" 2>/dev/null | \
                sed 's/^alias //' | \
                while IFS= read -r line; do
                    name="${line%%=*}"
                    desc="${line#*=}"
                    desc="${desc//[\'\"]/}"
                    if [[ ${#desc} -gt 50 ]]; then
                        desc="${desc:0:47}..."
                    fi
                    [[ -n "$name" ]] && printf "    %-15s - %s\n" "$name" "$desc"
                done
        echo ""

        echo "  ${BOLD}Tmux Commands:${NC}"
        echo "    vtup [session] - Create or attach to session"
        echo "    vtdown          - Detach current session"
        echo "    vtswitch <s>   - Switch to session"
        echo "    vtls            - List sessions"
        echo "    vtkill [s]     - Kill session"
        echo ""

        echo "  ${BOLD}Worktree Management (Functions):${NC}"
        echo "    wt <dir>              - Jump to worktree directory"
        echo "    wtls                  - List all worktrees"
        echo "    wtnew <branch> [agent] [base] - Create new worktree"
        echo "    wtrm <wt-dir>         - Remove worktree"
        echo "    wtrm all              - Remove all worktrees"
        echo "    wtinit [agent]        - Re-sync Git identity"
        echo "    wtrenew               - Refresh current worktree"
        echo "    vup <wt-dir> [agent]  - Setup tmux workspace"
        echo "    vnew <branch> [agent] - Create worktree + workspace"
        echo ""
    else
        echo "  ${YELLOW}No system aliases file found${NC}"
        echo ""
    fi

    echo "${BOLD}[Custom Aliases]${NC} ($CUSTOM_ALIASES_FILE)"
    if grep -q "^alias" "$CUSTOM_ALIASES_FILE" 2>/dev/null; then
        grep "^alias" "$CUSTOM_ALIASES_FILE" | \
            sed -E "s/^alias\s+([a-z][a-z0-9_]*)=['\"](.*)['\"]/\1 \2/" | \
            while read -r name desc; do
                [[ -n "$name" ]] && printf "    %-15s - %s\n" "$name" "$desc"
            done
    else
        echo "  (None defined)"
    fi

    echo ""
    echo "Run 'vibe alias help' for usage guide"
    echo "Run 'vibe alias edit' to add custom aliases"
}

do_edit() {
    open_editor "$CUSTOM_ALIASES_FILE"
}

do_inject() {
    # Check if custom aliases is sourced in .zshrc
    SHELL_RC="$HOME/.zshrc"

    if grep -q "source.*custom_aliases.sh" "$SHELL_RC"; then
        log_info "Custom aliases already configured in .zshrc"
    else
        append_to_rc "$SHELL_RC" "source \"$CUSTOM_ALIASES_FILE\"" "Vibe Custom Aliases"
        log_success "Added custom aliases to $SHELL_RC"
    fi

    # Source immediately for this subshell (doesn't affect parent, but good for check)
    source "$CUSTOM_ALIASES_FILE"
    log_info "To apply in current shell, run: source $CUSTOM_ALIASES_FILE"
}

do_help() {
    echo "vibe-alias - Manage Command Aliases"
    echo ""
    echo "Usage: vibe alias [command]"
    echo ""
    echo "Commands:"
    echo "  list, ls      List all configured aliases (default)"
    echo "  help          Show this help information"
    echo "  edit          Edit custom aliases file"
    echo "  inject        Inject aliases into shell configuration"
    echo ""
    echo "Examples:"
    echo "  vibe alias              # List all aliases"
    echo "  vibe alias list        # Same as above"
    echo "  vibe alias edit        # Open custom aliases file"
    echo "  vibe alias inject      # Add to .zshrc"
    echo ""
    echo "Quick Reference:"
    echo "  cc*, oo*, os*    Claude, OpenCode, OpenSpec commands"
    echo "  vc, vsign, vmain Vibe commands"
    echo "  vt, vtup, vtdown, vtls, vtkill  Tmux commands"
    echo "  vup, vnew        Workspace automation"
    echo "  wt, wtnew, wtrm  Worktree management"
    echo ""
}

case "${1:-list}" in
    list|ls)
        do_list
        ;;
    help|-h|--help)
        do_help
        ;;
    edit)
        do_edit
        ;;
    inject)
        do_inject
        ;;
    *)
        log_error "Unknown command: $1"
        do_help
        exit 2
        ;;
esac
